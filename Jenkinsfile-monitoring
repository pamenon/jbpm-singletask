pipeline {
    agent { 
		label 'maven' 
	}
    parameters {
        string(name: 'PROJECT_NAMESPACE', defaultValue: '', description: 'Your Paas(Openshift namespace) project name:')
        string(name: 'APP_NAME', defaultValue: '', description: 'Your App monitoring name: e.i: my-app')
        credentials credentialType: 'com.openshift.jenkins.plugins.OpenShiftTokenCredentials', name: 'rhpamsa', defaultValue: '', description: '', required: true
    }
   
    options {
        
        disableConcurrentBuilds()
       
        timeout(time: 15, unit: 'MINUTES')
    }
    environment {
        PORT = 8080;
    }
    stages {
       
       stage("Create Image Builder") {
	      	  when {
                expression {
                        openshift.withCluster() {
                            openshift.withProject("${params.PROJECT_NAMESPACE}") {
                                openshift.withCredentials("${rhpamsa}"){
                                    echo '# Checking if selector bc exist...'
                                    return !openshift.selector("bc", "${params.APP_NAME}-rhpamcentrmon").exists();
                                }
                            }
                           
                        }
                    }
              }
              steps {
                 	script {
		            	openshift.withCluster() {
                                    openshift.withProject("${params.PROJECT_NAMESPACE}") {
                                        openshift.withCredentials("${rhpamsa}"){
                                            sh 'oc project'
                                            echo 'Creating bc...'
                                            def bcmap = readYaml file: 'openshift/templates/rhpam711-prod-immutable-monitor.yaml';
                                            def bcmap2 = openshift.process(bcmap, "-p", "APPLICATION_NAME=${params.APP_NAME}", 
                                            "-p", "KIE_SERVER_CONTROLLER_OPENSHIFT_GLOBAL_DISCOVERY_ENABLED=true",
                                            "-p", "CREDENTIALS_SECRET=rhpam-credentials",
                                            "-p", "KIE_SERVER_ROUTER_HTTPS_SECRET=kieserver-app-secret",
                                            "-p", "BUSINESS_CENTRAL_HTTPS_SECRET=businesscentral-app-secret")
                                            openshift.apply(bcmap2)
                                    
                                    }
                                }
                            }
		                	
		         	}
	      	}
    	}
    	stage("rhpam-monitor-build") {
        	steps {
           	echo '### Create Linux Container Image from package ###'
           	script {
                    openshift.withCluster() {
                        openshift.withProject("${params.PROJECT_NAMESPACE}") {
                            openshift.withCredentials("${rhpamsa}"){
                                echo 'Start build...'
                                sh "oc describe build ${params.APP_NAME}-rhpamcentrmon"
                                echo 'Describe end...'
                                openshift.selector("bc", "${params.APP_NAME}-rhpamcentrmon").startBuild("--wait=true","--build-loglevel=5").logs('-f')
                                }
                            }   
                        }
            	}
        	}
    	}   	 
   	 
    	stage("rhpam-monitor-deploy") {
        	when {
            	expression {
                	openshift.withCluster() {                     
                            openshift.withProject("${params.PROJECT_NAMESPACE}") {
                                openshift.withCredentials("${rhpamsa}"){
                                return !openshift.selector('dc', "${params.APP_NAME}-rhpamcentrmon").exists()
                            }
                        }
                	}
            	}
        	}
        	steps {
            	echo '### to do deploy steps ###'
            	script {
                	openshift.withCluster() {
                        openshift.withProject("${params.PROJECT_NAMESPACE}") {
                            openshift.withCredentials("${rhpamsa}"){
                                    def app = openshift.newApp("${params.APP_NAME}-rhpamcentrmon:latest")
                                    app.narrow("svc").expose("--port=${env.PORT}");
                                    def dc = openshift.selector("dc", "${params.APP_NAME}-rhpamcentrmon")
                                    dc.rollout().status("--watch=true")
                                    dc.related('pods').logs()
                                    while (dc.object().spec.replicas != dc.object().status.availableReplicas) {
                                        sleep 10
                                    }
                                }
                            }
                        }
                    	
            	}
        	}
    	}
    	stage ('Verify Service') {
            steps {
                openshiftVerifyService(svcName: "${params.APP_NAME}-rhpamcentrmon", verbose: 'true')
            }
    	}
    }
}